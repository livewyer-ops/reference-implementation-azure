cnoe:
  enabled: true
  chartName: appset
  path: packages/charts/appset
  namespace: argocd
  releaseName: cnoe
  defaultVersion: 0.1.0
  selectorMatchLabels:
    cnoe.io/cluster: cnoe
  valueFiles:
    - ../../bootstrap/cnoe-addons.yaml
    - ../../addons/values.yaml

argocd:
  enabled: true
  chartName: argo-cd
  namespace: argocd
  releaseName: argocd
  defaultVersion: "8.0.14"
  chartRepository: "https://argoproj.github.io/argo-helm"
  valuesObject:
    dex:
      enabled: false
    configs:
      params:
        server.insecure: true
    server:
      ingress:
        enabled: true
        hostname: "argocd.local.{{ .metadata.annotations.domain }}"
  additionalResources:
    - manifestPath: ../bootstrap/manifests
      type: manifests

ingress-nginx:
  enabled: true
  chartName: ingress-nginx
  namespace: ingress-nginx
  releaseName: ingress-nginx
  defaultVersion: "4.7.0"
  chartRepository: "https://kubernetes.github.io/ingress-nginx"
  valuesObject:
    controller:
      kind: DaemonSet
      extraArgs:
        report-node-internal-ip-address: true
      ingressClassResource:
        default: true
      watchIngressWithoutClass: true
      service:
        type: NodePort
        nodePorts:
          http: 30080
          https: 30443
      hostPort:
        enabled: true
        ports:
          http: 80
          https: 443
      nodeSelector:
        ingress-ready: "true"
      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
        - key: node-role.kubernetes.io/master
          operator: Exists
          effect: NoSchedule

external-secrets:
  enabled: true
  namespace: external-secrets
  chartName: external-secrets
  defaultVersion: "0.17.0"
  chartRepository: "https://charts.external-secrets.io"
  valuesObject:
    podLabels: {}
    commonLabels: {}
    extraObjects:
      - apiVersion: external-secrets.io/v1
        kind: ClusterSecretStore
        metadata:
          annotations:
            argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
          name: azure-keyvault
        spec:
          provider:
            azurekv:
              vaultUrl: https://cnoe-ref-impl.vault.azure.net
              authType: ServicePrincipal
              tenantId: "{{ .metadata.annotations.tenantId }}"
              authSecretRef:
                clientId:
                  key: clientId
                  name: provider-azure
                  namespace: crossplane-system
                clientSecret:
                  key: clientSecret
                  name: provider-azure
                  namespace: crossplane-system

      - apiVersion: external-secrets.io/v1alpha1
        kind: PushSecret
        metadata:
          name: "{{ .metadata.annotations.keyvault }}-config"
          namespace: crossplane-system
        spec:
          refreshInterval: 30m
          secretStoreRefs:
            - name: azure-keyvault
              kind: ClusterSecretStore
          selector:
            secret:
              name: cnoe-config
          data:
            - conversionStrategy: None
              match:
                secretKey: config.json
                remoteRef:
                  remoteKey: config

crossplane:
  enabled: true
  chartName: crossplane
  namespace: crossplane-system
  releaseName: crossplane
  defaultVersion: "2.0.2-up.4"
  chartRepository: "https://charts.upbound.io/stable"
  valuesObject:
    extraObjects:
      - apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          annotations:
            nginx.ingress.kubernetes.io/ssl-redirect: "false"
          name: crossplane-dashboard
        spec:
          rules:
            - host: "crossplane.local.{{ .metadata.annotations.domain }}"
              http:
                paths:
                  - path: /
                    pathType: Prefix
                    backend:
                      service:
                        name: webui
                        port:
                          number: 80

      - apiVersion: kubernetes.m.crossplane.io/v1alpha1
        kind: ClusterProviderConfig
        metadata:
          annotations:
            argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
          name: default
        spec:
          credentials:
            source: InjectedIdentity

      - apiVersion: azure.m.upbound.io/v1beta1
        kind: ClusterProviderConfig
        metadata:
          annotations:
            argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
          name: default
        spec:
          credentials:
            source: Secret
            secretRef:
              key: credentials
              name: provider-azure
              namespace: crossplane-system

      - apiVersion: containerservice.azure.m.upbound.io/v1beta1
        kind: KubernetesCluster
        metadata:
          annotations:
            argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
            cnoe.io/cluster: "{{ .metadata.annotations.clusterName }}"
          labels:
            cnoe.io/cluster: "{{ .metadata.annotations.clusterName }}"
          name: "{{ .metadata.annotations.clusterName }}"
        spec:
          managementPolicies: ["Observe"]
          writeConnectionSecretToRef:
            name: cnoe-kubeconfig
          initProvider:
            defaultNodePool: {}
          forProvider:
            location: "{{ .metadata.annotations.location }}"
            resourceGroupName: "{{ .metadata.annotations.resourceGroup }}"

      - apiVersion: network.azure.m.upbound.io/v1beta1
        kind: DNSARecord
        metadata:
          annotations:
            argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
            crossplane.io/external-name: "*.local"
            cnoe.io/domain: "{{ .metadata.annotations.domain }}"
          labels:
            cnoe.io/domain: "{{ .metadata.annotations.domain }}"
          name: "wildcard.local.{{ .metadata.annotations.domain }}"
        spec:
          managementPolicies: ["Observe", "Update"]
          forProvider:
            resourceGroupName: "{{ .metadata.annotations.resourceGroup }}"
            records:
              - 127.0.0.1
            ttl: 3600
            zoneName: "{{ .metadata.annotations.domain }}"

      - apiVersion: keyvault.azure.m.upbound.io/v1beta1
        kind: Vault
        metadata:
          annotations:
            argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
            cnoe.io/keyvault: "{{ .metadata.annotations.keyvault }}"
          labels:
            cnoe.io/keyvault: "{{ .metadata.annotations.keyvault }}"
          name: "{{ .metadata.annotations.keyvault }}"
        spec:
          managementPolicies: ["Observe", "Update", "Create"]
          forProvider:
            location: "{{ .metadata.annotations.location }}"
            resourceGroupName: "{{ .metadata.annotations.resourceGroup }}"
            tenantId: "{{ .metadata.annotations.tenantId }}"
            enableRbacAuthorization: true
            skuName: standard
            softDeleteRetentionDays: 7
            tags:
              managed-by: external-secrets

      - apiVersion: azure.livewyer.io/v1alpha1
        kind: WorkloadIdentity
        metadata:
          annotations:
            argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
          labels:
            cnoe.io/cluster: "{{ .metadata.annotations.clusterName }}"
          name: crossplane
        spec:
          managementPolicies: ["Observe", "Update", "Create"]
          forProvider:
            location: "{{ .metadata.annotations.location }}"
            oidcIssuerURL: "{{ .metadata.annotations.clusterOIDCIssuerURL }}"
            resourceGroupName: "{{ .metadata.annotations.resourceGroup }}"
            roleAssignments:
              - roleDefinitionName: Owner
                scope: "/subscriptions/{{ .metadata.annotations.subscription }}/resourceGroups/{{ .metadata.annotations.resourceGroup }}"
            serviceAccountName: crossplane

      - apiVersion: batch/v1
        kind: Job
        metadata:
          name: provider-kubernetes-config
          namespace: crossplane-system
          annotations:
            argocd.argoproj.io/sync-wave: "50"
        spec:
          template:
            spec:
              serviceAccountName: upbound-controller-manager
              restartPolicy: Never
              containers:
                - name: provider-kubernetes-config
                  image: docker.io/bitnamilegacy/kubectl
                  command: ["/bin/bash", "-c"]
                  args:
                    - |
                      #! /bin/bash
                      set -e -o pipefail

                      while [[ $(kubectl -n crossplane-system get sa -o yaml | yq '[.items[] | select(.metadata.name=="*provider-kubernetes*")] | length') -eq 0 ]]; do
                        sleep 5
                      done
                      SA=$(kubectl -n crossplane-system get sa -o yaml | yq '.items[] | select(.metadata.name=="*provider-kubernetes*").metadata.name')
                      kubectl create clusterrolebinding provider-kubernetes-admin-binding \
                        --clusterrole cluster-admin \
                        --serviceaccount="crossplane-system:${SA}" && \
                      echo "Done" || echo "Error"
